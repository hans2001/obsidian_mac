09:56
## TODO

- [ ] work on the c++ proj
	- [ ] define the scope and start working on the first feature
	- [ ] learn vim motions
		- [ ] create files
		- [ ] navigate files
		- [ ] go back
- [ ] learn how to use codex cli!
- [ ] finish all hackerrank c++ problems!
- [ ] use neovim to try out some of the cp problems( )
	- [ ] define a plan for the cp progress

## Thoughts


-- ~/.config/nvim-proj/init.lua
-- PROJ profile: C++ 工程（clangd + cmake + 多文件导航）

-- ================
-- Basics
-- ================
vim.g.mapleader = " "
vim.opt.number = true
vim.opt.relativenumber = true
vim.opt.mouse = "a"
vim.opt.clipboard = "unnamedplus"
vim.opt.expandtab = true
vim.opt.tabstop = 2
vim.opt.shiftwidth = 2
vim.opt.smartindent = true
vim.opt.ignorecase = true
vim.opt.smartcase = true
vim.opt.updatetime = 200
vim.opt.signcolumn = "yes"

-- 保存时自动格式化（仅在 LSP 存在时）
vim.api.nvim_create_autocmd("BufWritePre", {
  pattern = { "*.c", "*.cc", "*.cpp", "*.h", "*.hpp" },
  callback = function()
    pcall(vim.lsp.buf.format, { async = false })
  end,
})

-- ================
-- Bootstrap lazy.nvim
-- ================
local lazypath = vim.fn.stdpath("data") .. "/lazy/lazy.nvim"
if not vim.uv.fs_stat(lazypath) then
  vim.fn.system({
    "git", "clone", "--filter=blob:none",
    "https://github.com/folke/lazy.nvim.git",
    "--branch=stable",
    lazypath,
  })
end
vim.opt.rtp:prepend(lazypath)

-- ================
-- Helpers
-- ================
local function term_split(cmd)
  vim.cmd("botright split | resize 12 | terminal " .. cmd)
end

-- project root：compile_commands.json / CMakeLists / .git
local function project_root()
  local markers = { "compile_commands.json", "CMakeLists.txt", ".git" }
  local path = vim.fn.expand("%:p")
  if path == "" then return vim.loop.cwd() end
  local dir = vim.fs.dirname(path)
  local found = vim.fs.find(markers, { upward = true, path = dir })[1]
  if found then return vim.fs.dirname(found) end
  return vim.loop.cwd()
end

-- ================
-- Plugins
-- ================
require("lazy").setup({
  { "nvim-lua/plenary.nvim" },

  -- Telescope
  {
    "nvim-telescope/telescope.nvim",
    dependencies = { "nvim-lua/plenary.nvim" },
    config = function()
      require("telescope").setup({
        defaults = {
          mappings = {
            i = {
              ["<C-j>"] = "move_selection_next",
              ["<C-k>"] = "move_selection_previous",
            },
          },
        },
      })
    end,
  },

  -- Treesitter
  {
    "nvim-treesitter/nvim-treesitter",
    branch = "master",
    build = ":TSUpdate",
    main = "nvim-treesitter.configs",
    opts = {
      ensure_installed = { "c", "cpp", "lua", "bash", "vim", "vimdoc" },
      highlight = { enable = true },
      indent = { enable = true },
    },
  },

  -- LSP
  { "neovim/nvim-lspconfig" },

  -- Completion
  { "hrsh7th/nvim-cmp" },
  { "hrsh7th/cmp-nvim-lsp" },
  { "L3MON4D3/LuaSnip" },
  { "saadparwaiz1/cmp_luasnip" },

  -- Explorer（回目录）
  { "stevearc/oil.nvim", opts = {} },

  -- Git（工程必备）
  { "lewis6991/gitsigns.nvim", opts = {} },
}, {
  rocks = { enabled = false },
})

-- ================
-- LSP: clangd
-- ================
local lspconfig = require("lspconfig")
local clangd = os.getenv("CLANGD_PATH") or "clangd"

lspconfig.clangd.setup({
  cmd = {
    clangd,
    "--background-index",
    "--clang-tidy",
    "--completion-style=detailed",
    "--header-insertion=iwyu",
    "--pch-storage=memory",
    "--function-arg-placeholders",
    "--fallback-style=LLVM",
  },
  root_dir = function() return project_root() end,
})

vim.api.nvim_create_autocmd("LspAttach", {
  callback = function(ev)
    local opts = { buffer = ev.buf, silent = true }
    vim.keymap.set("n", "gd", vim.lsp.buf.definition, opts)
    vim.keymap.set("n", "gD", vim.lsp.buf.declaration, opts)
    vim.keymap.set("n", "gr", vim.lsp.buf.references, opts)
    vim.keymap.set("n", "gi", vim.lsp.buf.implementation, opts)
    vim.keymap.set("n", "K", vim.lsp.buf.hover, opts)
    vim.keymap.set("n", "<leader>rn", vim.lsp.buf.rename, opts)
    vim.keymap.set("n", "<leader>ca", vim.lsp.buf.code_action, opts)
    vim.keymap.set("n", "<leader>dd", vim.diagnostic.open_float, opts)
    vim.keymap.set("n", "[d", vim.diagnostic.goto_prev, opts)
    vim.keymap.set("n", "]d", vim.diagnostic.goto_next, opts)
  end,
})

-- ================
-- nvim-cmp
-- ================
local cmp = require("cmp")
local luasnip = require("luasnip")

cmp.setup({
  snippet = { expand = function(args) luasnip.lsp_expand(args.body) end },
  mapping = cmp.mapping.preset.insert({
    ["<C-Space>"] = cmp.mapping.complete(),
    ["<CR>"] = cmp.mapping.confirm({ select = true }),
    ["<Tab>"] = cmp.mapping(function(fallback)
      if cmp.visible() then
        cmp.select_next_item()
      elseif luasnip.expand_or_jumpable() then
        luasnip.expand_or_jump()
      else
        fallback()
      end
    end, { "i", "s" }),
    ["<S-Tab>"] = cmp.mapping(function(fallback)
      if cmp.visible() then
        cmp.select_prev_item()
      elseif luasnip.jumpable(-1) then
        luasnip.jump(-1)
      else
        fallback()
      end
    end, { "i", "s" }),
  }),
  sources = {
    { name = "nvim_lsp" },
    { name = "luasnip" },
  },
})

-- ================
-- Keymaps: 项目导航 / 工程命令
-- ================
local builtin = require("telescope.builtin")

-- 文件 / 搜索（project root）
vim.keymap.set("n", "<leader>ff", function()
  builtin.find_files({ cwd = project_root() })
end, { desc = "Find files (project)" })

vim.keymap.set("n", "<leader>fg", function()
  builtin.live_grep({ cwd = project_root() })
end, { desc = "Grep (project)" })

vim.keymap.set("n", "<leader>fb", builtin.buffers, { desc = "Buffers" })

-- Explorer
vim.keymap.set("n", "<leader>e", function()
  require("oil").open(project_root())
end, { desc = "Explorer (project)" })

-- Buffer / Quit
vim.keymap.set("n", "<leader>q", "<cmd>bd<cr>", { desc = "Close buffer" })
vim.keymap.set("n", "<leader>x", "<cmd>bd!<cr>", { desc = "Force close buffer" })
vim.keymap.set("n", "<leader>w", "<cmd>w<cr>", { desc = "Save" })
vim.keymap.set("n", "<leader>Q", "<cmd>qa<cr>", { desc = "Quit all" })

-- CMake
vim.keymap.set("n", "<leader>pc", function()
  local root = project_root()
  term_split(
    "cd " .. vim.fn.shellescape(root) ..
    " && cmake -S . -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON" ..
    " && ln -sf build/compile_commands.json compile_commands.json"
  )
end, { desc = "CMake configure" })

vim.keymap.set("n", "<leader>pb", function()
  term_split("cd " .. vim.fn.shellescape(project_root()) .. " && cmake --build build -j")
end, { desc = "CMake build" })

-- Run（可输入 target）
local last_run = "a"
vim.keymap.set("n", "<leader>pr", function()
  local root = project_root()
  local name = vim.fn.input("Run target (build/): ", last_run)
  if name == "" then return end
  last_run = name
  term_split("cd " .. vim.fn.shellescape(root) .. " && ./build/" .. vim.fn.shellescape(name))
end, { desc = "Run target" })